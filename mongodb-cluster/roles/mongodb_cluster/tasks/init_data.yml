- name: Initialize data replica set (run on primary node)
  shell: |
    mongosh --port {{ data_port }} --quiet --eval '
    try {
      rs.initiate({
        _id: "{{ data_replset }}",
        members: [
          { _id: 0, host: "192.168.121.101:{{ data_port }}" },
          { _id: 1, host: "192.168.121.102:{{ data_port }}" },
          { _id: 2, host: "192.168.121.103:{{ data_port }}" },
          { _id: 3, host: "192.168.121.104:{{ data_port }}" },
          { _id: 4, host: "192.168.121.105:{{ data_port }}" },
          { _id: 5, host: "192.168.121.108:{{ arbiter_port }}", arbiterOnly: true }
        ]
      })
    } catch (e) {
      print("Replica set may already be initialized: " + e)
    }
    rs.status()
    '
  register: data_rs_init
  ignore_errors: yes

- name: Pause for replica set stabilization
  pause:
    seconds: 40
